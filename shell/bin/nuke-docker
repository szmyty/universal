#!/usr/bin/env bash
# docker-clean: Safely remove Docker resources by label or everything if --all is passed

set -euo pipefail

USE_COLOR=true
FORCE=false
USE_LABELS=true
DANGEROUS=false
NUKE_ALL=false
DRY_RUN=false

CLEAN_CONTAINERS=true
CLEAN_VOLUMES=false
CLEAN_NETWORKS=false

LABEL_NAME=""
LABEL_SCOPE=""

# ─────────────────────────────────────────────────────────────────────────────
# Color + Logging
# ─────────────────────────────────────────────────────────────────────────────
color() {
    [[ "${USE_COLOR}" == true ]] || return 0
    case "$1" in
    reset) echo -e "\033[0m" ;;
    cyan) echo -e "\033[36m" ;;
    green) echo -e "\033[32m" ;;
    yellow) echo -e "\033[33m" ;;
    red) echo -e "\033[31m" ;;
    *) echo "" ;;
    esac
}

log() {
    local type="$1"
    shift
    local prefix color_code output

    case "${type}" in
    info)
        prefix="👉"
        color_code=$(color cyan)
        ;;
    success)
        prefix="✅"
        color_code=$(color green)
        ;;
    warn)
        prefix="⚠️"
        color_code=$(color yellow)
        ;;
    error)
        prefix="❌"
        color_code=$(color red)
        ;;
    *)
        prefix=""
        color_code=$(color reset)
        ;;
    esac

    output="${color_code}${prefix} $*$(color reset)"
    if [[ "${type}" == "error" ]]; then
        printf "%s\n" "${output}" >&2
        exit 1
    else
        printf "%s\n" "${output}"
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# Docker Filters
# ─────────────────────────────────────────────────────────────────────────────
filter_by_labels() {
    if [[ "${USE_LABELS}" == true ]]; then
        docker "$@" --filter "label=${LABEL_NAME}" --filter "label=${LABEL_SCOPE}"
    else
        docker "$@"
    fi
}

stop_containers() {
    [[ "${CLEAN_CONTAINERS}" == true ]] || return 0
    log info "Stopping containers..."
    filter_by_labels ps -aq | while read -r cid; do
        log info "Stopping container: ${cid}"
        [[ "${DRY_RUN}" == false ]] && docker stop "${cid}" || true
    done
}

remove_containers() {
    [[ "${CLEAN_CONTAINERS}" == true ]] || return 0
    log info "Removing containers..."
    filter_by_labels ps -aq | while read -r cid; do
        log info "Removing container: ${cid}"
        [[ "${DRY_RUN}" == false ]] && docker rm --force "${cid}" || true
    done
}

remove_networks() {
    [[ "${CLEAN_NETWORKS}" == true || "${NUKE_ALL}" == true ]] || {
        log info "Skipping network removal (use --networks to enable)"
        return 0
    }

    log info "Removing networks..."

    if [[ "${USE_LABELS}" == true ]]; then
        docker network ls --filter "label=${LABEL_NAME}" --filter "label=${LABEL_SCOPE}" -q | while read -r net_id; do
            net_name=$(docker network inspect --format '{{ .Name }}' "${net_id}")
            log info "Removing network: ${net_name} (${net_id})"
            [[ "${DRY_RUN}" == false ]] && docker network rm "${net_id}" || true
        done
    else
        docker network ls -q | while read -r net_id; do
            net_name=$(docker network inspect --format '{{ .Name }}' "${net_id}")
            [[ "${net_name}" =~ ^(bridge|host|none)$ ]] && continue
            log info "Removing network: ${net_name} (${net_id})"
            [[ "${DRY_RUN}" == false ]] && docker network rm "${net_id}" || true
        done
    fi
}

remove_volumes() {
    [[ "${CLEAN_VOLUMES}" == true || "${NUKE_ALL}" == true ]] || {
        log info "Skipping volume removal (use --volumes to enable)"
        return 0
    }

    log info "Removing volumes..."

    if [[ "${USE_LABELS}" == true ]]; then
        docker volume ls --filter "label=${LABEL_NAME}" --filter "label=${LABEL_SCOPE}" -q | while read -r vol_id; do
            log info "Removing volume: ${vol_id}"
            [[ "${DRY_RUN}" == false ]] && docker volume rm "${vol_id}" || true
        done
    else
        docker volume ls -q | while read -r vol_id; do
            log info "Removing volume: ${vol_id}"
            [[ "${DRY_RUN}" == false ]] && docker volume rm "${vol_id}" || true
        done
    fi
}

remove_images() {
    if [[ "${DANGEROUS}" == true ]]; then
        log warn "Removing Docker images..."
        docker images -aq | while read -r img_id; do
            log info "Removing image: ${img_id}"
            [[ "${DRY_RUN}" == false ]] && docker rmi --force "${img_id}" || true
        done
    else
        log info "Skipping image removal (use --dangerous to enable)"
    fi
}

clean_build_cache() {
    log info "Cleaning Docker build cache..."
    [[ "${DRY_RUN}" == false ]] && docker builder prune --all --force || log info "(dry-run) Would run: docker builder prune --all --force"
}

system_prune() {
    if [[ "${DANGEROUS}" == true ]]; then
        log warn "Performing system prune..."
        [[ "${DRY_RUN}" == false ]] && docker system prune --all --volumes --force || log info "(dry-run) Would run: docker system prune --all --volumes --force"
    fi
}

# ─────────────────────────────────────────────────────────────────────────────
# Flow Control
# ─────────────────────────────────────────────────────────────────────────────
main() {
    stop_containers
    remove_containers
    remove_networks
    remove_volumes
    remove_images
    clean_build_cache
    system_prune
    log success "Docker cleanup complete."
}

usage() {
    cat <<EOF
Usage: $(basename "$0") [options]

Options:
  --label-name VALUE       Docker app.name label (required unless --all)
  --label-scope VALUE      Docker app.scope label (required unless --all)
  --all                    Ignore labels and nuke all matching resources
  --volumes                Also remove volumes (default: off unless --all)
  --networks               Also remove networks (default: off unless --all)
  --only-containers        Only remove containers (implies --no-volumes --no-networks)
  --only-volumes           Only remove volumes (disables container/network cleanup)
  --only-networks          Only remove networks (disables container/volume cleanup)
  --dangerous              Also remove images and run system prune
  --dry-run                Show what would be removed, but don't actually remove it
  --force                  Skip confirmation prompt
  --no-color               Disable colored output
  -h, --help               Show this help message
EOF
    exit 1
}

main_wrapper() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
        --label-name)
            LABEL_NAME="$2"
            shift
            ;;
        --label-scope)
            LABEL_SCOPE="$2"
            shift
            ;;
        --all)
            USE_LABELS=false
            NUKE_ALL=true
            ;;
        --dangerous) DANGEROUS=true ;;
        --volumes) CLEAN_VOLUMES=true ;;
        --networks) CLEAN_NETWORKS=true ;;
        --only-containers)
            CLEAN_CONTAINERS=true
            CLEAN_VOLUMES=false
            CLEAN_NETWORKS=false
            ;;
        --only-volumes)
            CLEAN_CONTAINERS=false
            CLEAN_VOLUMES=true
            CLEAN_NETWORKS=false
            ;;
        --only-networks)
            CLEAN_CONTAINERS=false
            CLEAN_VOLUMES=false
            CLEAN_NETWORKS=true
            ;;
        --dry-run) DRY_RUN=true ;;
        --force) FORCE=true ;;
        --no-color) USE_COLOR=false ;;
        -h | --help) usage ;;
        *)
            log error "Unknown argument: $1"
            usage
            ;;
        esac
        shift
    done

    if [[ "${USE_LABELS}" == true ]]; then
        [[ -z "${LABEL_NAME}" || -z "${LABEL_SCOPE}" ]] && log error "--label-name and --label-scope are required unless --all is used."
    fi

    log warn "You are about to remove Docker resources..."
    [[ "${NUKE_ALL}" == true ]] && log warn "☢️  --all specified: This will ignore labels and clean EVERYTHING."
    [[ "${DANGEROUS}" == true ]] && log warn "🔥 --dangerous specified: Images and build cache will also be deleted."
    [[ "${USE_LABELS}" == true ]] && log info "Label filters: ${LABEL_NAME}, ${LABEL_SCOPE}"
    [[ "${DRY_RUN}" == true ]] && log warn "🔍 Dry-run mode enabled — nothing will actually be removed."

    if [[ "${FORCE}" == true ]]; then
        main
    else
        read -rp "Are you sure? (y/N): " confirm
        if [[ "${confirm}" =~ ^[Yy]$ ]]; then
            main
        else
            log error "Cancelled."
        fi
    fi
}

main_wrapper "$@"
